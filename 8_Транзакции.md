## 8. Транзации


1. Информационная клиент-серверная система на платформе "1С:Предприятие 8.3" работает в управляемом режиме блокировок данных с включенным режимом совместимости с "1С:Предприятие 8.2". Какие уровни изоляции транзакции при этом будут использоваться в СУБД MS SQL Server?
>

2. Информационная клиент-серверная система на платформе "1С:Предприятие 8.3" работает в управляемом режиме блокировок без режима совместимости с "1С:Предприятие 8.2". Какие уровни изоляции транзакции при этом будут использоваться в СУБД MS SQL?
>

3. Информационная клиент-серверная система на платформе "1С:Предприятие 8.3" работает в автоматическом режиме блокировок данных со снятым режимом совместимости. Какие уровни изоляции транзакции при этом будут использоваться в СУБД MS SQL Server?
>

4. Информационная клиент-серверная система на платформе "1С:Предприятие 8.3" работает в автоматическом режиме блокировок данных. Какие уровни изоляции транзакций при этом будут использоваться в СУБД MS SQL Server для операций записи?
>

5. WAL применительно к транзакции это:
> Протокол журнализации (и управления буферизацией) **Write Ahead Log** (WAL) — **пиши сначала в журнал**

6. Протокол WAL имеет следующий смысл:
> Если во внешней памяти базы данных **находится некоторый объект базы данных**, по отношению к которому выполнена операция модификации, то во внешней памяти журнала обязательно **находится запись**, соответствующая этой операции.

7. Что такое транзакция?
> **Транзакция — неделимая** с точки зрения воздействия на БД **последовательность операторов** манипулирования данными (чтения, удаления, вставки, модификации) такая, что **либо результаты всех операторов**, входящих в транзакцию, **отображаются в БД, либо воздействие** всех этих операторов **полностью отсутствует**.
> 
> **Транзакция — минимальная логически осмысленная операция**, которая имеет смысл и может быть совершена только полностью. 
> 
> Ответ: 1 и 2

8. UNDO логи хранят:
> Старые версии данных

9. Consistency (Согласованность) в ACID
> Является необходимым условием для обеспечения **надежности**

10. REDO логи хранят:
> Новые версии данных

11. Atomicity (Атомарность) в ACID
> Гарантирует, что никакая транзакция **не будет зафиксирована** в системе **частично**

12. Уровень изоляции транзакции это:
> То, насколько транзакции изолированы друг от друга (обратно — то, **насколько изолированы друг от друга несогласованные данные**), называется уровнем изоляции транзакций.

13. Код на встроенном языке содержит одну транзакцию, вложенную в другую. Какие действия будут отменены в результате выполнения **ОтменитьТранзакцию()** в коде вложенной транзакции?
>  Будут отменены и вложенная, и внешняя транзакции

14. Используется ли при работе с 1С уровень изоляции **Repeatable Read**?
> Используется **в автоматическом** режиме управления блокировками

15. База работает в управляемом режиме управления блокировками, используется СУБД MS SQL Server 2012, платформа **"1С:Предприятие 8.3"** без режима совместимости, все настройки соответствуют настройкам по умолчанию. В одной из транзакций произошла эскалация блокировок СУБД на регистре бухгалтерии "Хозрасчетный". **Другая транзакция пытается прочитать данные из этого регистра. Что произойдет?**
> Без ожиданый будет прочитана версия данных, согласованная на момент начала второй транзакции

16. База работает в управляемом режиме управления блокировками, используется СУБД MS SQL Server 2012, платформа "1С:Предприятие 8.2" без режима совместимости, все настройки соответствуют настройкам по умолчанию. В одной из транзакций произошла эскалация блокировок СУБД на регистре бухгалтерии "Хозрасчетный". Другая транзакция пытается прочитать данные из этого регистра. Что произойдет?
> Данные будут прочитаны только после окончания блокирующей транзакции
> Данные не будут прочитаны, возникнет конфликт блокировок
> 
> Ответ: 1 или 2

17. RCSI для MS SQL Server это:
> RCSI — Read Commited Snapshot Isolation *(Подтверждеенное чтение с **включенным** параметром READ_COMMITED_SNAPSHOT)*.
> 
> Уровень изоляции транзакции

18. Куда записывается снимок при использовании Read Committed Snapshot для MS SQL Server?
> В **tempdb** хранятся как временные таблицы, так и снимки Snapshot для RCSI

19. Какие проблемы решает уроверь изоляции **Read Commited**?
> *Read Committed (подтвержденное чтение, **изоляция зафиксированного чтения**) (параметр READ_COMMITTED_SNAPSHOT **выключен**)*
> 
> Ответ: смотри таблицу 

20. Какие проблемы решает, а какие не решает уроверь изоляции Read Uncommited?
> *Read Uncommitted (неподтвержденное чтение, **изоляция незафиксированного
чтения**)*
>
>  Самый низкий уровень, при котором транзакции изолируются до такой степени, чтобы только уберечь от считывания физически поврежденных данных.
>  > 
> Ответ: смотри таблицу 

21. Какие проблемы решает, а какие не решает уроверь изоляции Read Commited Snapshot?
> *Read Committed Snapshot (подтвержденное чтение с **включенным** параме-
тром READ_COMMITTED_SNAPSHOT)*
> 
> В момент начала чтения транзакции будет выделен моментальный снимок
(snapshot) базы данных, включающий в себя все изменения завершенных к этому
моменту времени транзакций. Транзакция может читать этот снимок, получая
чистые данные (без «грязного» чтения) и при этом никого не блокируя
> 
> Ответ: смотри таблицу 

22. Какие проблемы решает, а какие не решает уроверь изоляции Repeatable Read?
> *Repeatable Read (повторяемое чтение, изоляция повторяющегося чтения)*
> 
> Ответ: смотри таблицу 

23. Используется ли технологической платформой уровень изоляции Snapshot?
>
> Нет

24. Какие проблемы решает, а какие не решает уроверь изоляции Serializable?
>
> Serializable по сути ставит транзакции в очередь.
> Предотвращает **все возможные проблемы**.

25. Что такое проблема потерянного обновления?
> Потерянное обновление (англ. lost update) – если один и тот же блок данных одно-
временно изменяют две разные транзакции, то будет зафиксировано только одно
изменение, второе потеряется (при работе «1С» невозможно, поскольку в «1С»
не бывает записи вне транзакции)

26. Что такое проблема "грязного" чтения?
> «Грязное» чтение (англ. dirty read) – чтение данных, добавленных или измененных
транзакцией, может дать неточный результат, потому что та транзакция впослед-
ствии не подтвердится (откатится)

27. Что такое проблема неповторяющегося чтения?
> Неповторяющееся чтение (англ. non-repeatable read) – при повторном чтении
в рамках одной и той же транзакции оказывается, что ранее прочитанные данные
изменены или удалены

28. Что такое проблема фантомов?
> Фантомное чтение (англ. phantom reads) – при повторном чтении в рамках одной
и той же транзакции оказывается, что прочитаны строки, которых при преды-
дущих чтениях не было (новые строки называют «фантомными»)

29. Как определить, что используется именно автоматический режим управления блокировками?
> 
> **Посмотреть свойство конфигурации** "Режим управления блокировкой данных" 

30. Как определить, что используется именно автоматический режим управления блокировками?
> `В управляемой блокировке WITH READ COMMITED (?) стр. 42 настрольной книги`
> В тексе запроса, пришедшем на SQL Server, есть подстроки **WITH SERIALIZABLE** и **WITH REPEATABLE READ**
> Ответ: 1 и 2

31. ACID применительно к транзакциям это:
> 1. **Atomacity**	 — Атомарность
> 2. **Consistency** — Постоянство (Согласованность) 
>  3. **Isolation**	 — Изолированность
>  4. **Durability**	 — Надежность/Устройчивость (Долговечность)
>  
>  Ответ: 1 и 2 (тонкости перевода)

32. Атомарность применительно к транзакциям это:
> Всё или ничего: транзакция должна или пройти или не пройти полностью.

33. Какой из ответов правильно описывает свойство согласованности (Consistency) применительно к транзакциям?
> Каждая **успешная транзакция** по определению фиксирует только допустимые результаты, **не нарушает бизнес-логику** и отношения между элементами данных.

34. Изолированность транзакции — это:
> **Обеспечение целостности данных** независимо от действий других пользователей

35. Устойчивость (Durability) применительно к транзакции это:
> После своего завершения **она сохраняется в системе**, которую ничто не может вернуть в исходное (до начала транзакции) состояние.

36. Как связаны блокировки и транзакции?
>Транзакци и блокировки тесно связаны друг с другом. **Транзакции накладывают блокировки на данные**, чтобы обеспечить выполнение требований ACID.

37. Наиболее распространенным в централизованных СУБД (включающих системы, основанные на архитектуре "клиент-сервер"):
> Для обеспечения сериализации транзакций синхронизационные захваты объектов, произведенные по инициативе транзакции, можно снимать только при её завершении. Это требование порождает **двухфазный протокол синхронизационных захватов — 2PL**.


38. В общих чертах подход двухфазного протокола синхронизационных захватов объектов баз данных (Two-Phase Locking Protocol, 2PL) состоит в следующем:
> - Первая фаза транзакции — **накопление захватов**;
> - Вторая фаза (фиксация или откат) — **освобождение захватов**.

39. Пессимистическая блокировка устанавливается:
> Суть его работы заключается в том, чтобы запретить (заблокировать) изменение данных объекта информационной базы другими сеансами (или этим сеансом) до тех пор, пока эта блокировка не будет снята.
>
> Например, как только пользователь начинает редактировать какое-либо поле в форме, **расширение формы** устанавливает пессимистическую блокировку на данные объекта, редактируемого в форме.
> 
> https://its.1c.ru/db/pubessence/content/148/hdoc

40. Оптимистическая блокировка устанавливается:
> **Оптимистическая блокировка запрещает запись** объекта в базу данных, **если после считывания** объекта **он был изменен** в базе данных. 
> Строго говоря, оптимистическая блокировка представляет собой **проверку**, которая **выполняется перед записью** объекта **в базу данных**.
>
> Из предложенных вариантов ответа считывает объект метод **ПолучитьОбъект()**

41. Оптимистическая блокировка снимается:
>  Будет держаться, **пока объект есть в памяти** (например, до конца процедуры)

42. Вложенные транзакции:
> Не поддерживаются в 1С

43. Как найти длительную транзакцию?


## ACID

|  |  |
|--|--|
| **Atomacity**	 | Транзакция **либо провелась, либо не провелась** |
| **Consistency**	 |  Если до начала транзакции данные находили в **good state**, то и после они будут находиться в **good state** |
| **Isolation**	 | см. Несогласованности данных |
| **Durability**	 | После коммита **данные точно записаны в постоянное хранилище** |




## Несогласованности данных:

| | |
|---|---|
| **«грязное»** чтение<br>(dirty read) | чтение данных, добавленных или измененных<br>транзакцией, может дать неточный результат, <br>потому что та **транзакция впоследствии <br>не подтвердится** (откатится) |
| **неповторяющееся** чтение<br>(non-repeatable read) | при повторном чтении в рамках одной и той же <br>транзакции оказывается, что **ранее прочитанные <br>данные изменены** или удалены |
| **фантомное** чтение<br>(phantom reads) | при повторном чтении в рамках одной и той же <br>транзакции оказывается, что прочитаны **строки, <br>которых при предыдущих чтениях не было** <br>(новые строки называют «фантомными») |

##  Про уровни изоляции

|  |  | 
|-------------------------|------------|
| Read Uncommitted        | Игнорирует | 
| Read Committed <br> Snapshot (RCSI) | Нет        | 
| Read Committed          | Ждёт когда Т1 вернёт Commited (фантомы) |
| Repeatable Read         | Делает снапшот до выполнения Т1 (игнорирует изменения Т1) |
| Serializable            | Просто ставит транзакции в очередь (полностью защищает от несогласованностей) |


## Какие проблемы решает какой уровень изоляции:

| Уровень изоляции        | «Грязное»  | Неповторяющееся  | Фантомное  |
|-------------------------|------------|------------------|------------|
| Read Uncommitted        | Да         | Да               | Да         |
| Read Committed <br> Snapshot (RCSI) | Нет  | Да         | Да         |
| Read Committed          | Нет        | Да               | Да         |
| Repeatable Read         | Нет        | Нет              | Да         |
| Serializable            | Нет        | Нет              | Нет        |







![изображение](https://github.com/GreatFireDragon/1C/assets/90414648/7a38d83a-c7ef-4b54-b0fb-a4c1901c2b08)
↑ вопрос 13 ↑

Уровни изоляции:
![изображение](https://github.com/GreatFireDragon/1C/assets/90414648/ab7782b0-99dc-4c24-afaa-543b4d64e0c7)

Пример двух "пересекающихся" транзакций:
![изображение](https://github.com/GreatFireDragon/1C/assets/90414648/f2852bfe-39f8-4168-91bf-d48df8fe5838)





> Written with [StackEdit](https://stackedit.io/).
