
# 9. Блокировки, избыточные блокировки и методы оптимизации

## НСИ

**Несовместимая** блокировка (TLOCK), **Таймаут** (TTIMEOUT), **Взаимоблокировка** (TDEADLOCK), **Эскалация** (повышение гранулярности) блокировки

| **Имя пространства блокировок** | **Поля пространства блокировок** |
|---|---|
|  Справочник.<имя>  |  Ссылка |
|  Документ.<имя>  |   Ссылка |
|  ПланОбмена.<имя>  |   Ссылка |
|  ПланСчетов.<имя>  |   Ссылка |
|  БизнеcПроцесс.<имя>  |   Ссылка |
|  Задача.<имя>  |   Ссылка |
|  ПланВидовРасчета.<имя>  |   Ссылка |
|  ПланВидовХарактеристик.<имя>  |   Ссылка |
|  РегистрСведений.<имя>.НаборЗаписей |  Регистратор |
|  РегистрСведений.<имя>  |  Период - если есть; <имя измерения> |
|  РегистрНакопления.<имя>.НаборЗаписей  |  Регистратор |
|  РегистрНакопления.<имя>  | Период; <имя измерения> |
|  РегистрБухгалтерии.<имя>.НаборЗаписей  |  Регистратор |
|  РегистрБухгалтерии.<имя>  |  Период; <вид движения> - значение системного перечисления; ВидДвиженияБухгалтерии; Счет - обязательное поле; Субконто; <вид субконто>; <имя измерения> |
|  РегистрРасчета.<имя>.НаборЗаписей  |  Регистратор |
|  РегистрРасчета.<имя>  |  ПериодРегистрации; ПериодДействия; <имя измерения> |
|  Перерасчет.<имя>.НаборЗаписей  |  ОбъектПерерасчета |
|  Перерасчет.<имя>  |  ВидРасчета |
|  Последовательность.<имя>.НаборЗаписей  |  Регистратор |
|  Последовательность.<имя>  |  <имя измерения> |
|  Константа.<имя>  | Нет полей |
 ↑только для регистра сведений, подчиненного регистратору↑ 


## Вопросы и ответы


1. Будет ли в технологическом журнале TLOCK, если управляемую блокировку установить не удалось?
> Будет

2. В простых случаях, чтобы найти виновника таймаута или взаимоблокировки на управляемых блокировках, достаточно найти:
> В простых случаях, чтобы найти виновника конфликта блокировок, достаточно найти, какую именно управляемую блокировку, **не совместимую с блокировкой-жертвой**, установило соединение, указанное в WaitConnections.

3. В чем отличие поведения **эскалации блокировок СУБД** MS SQL Server от **эскалации управляемых блокировок 1С**?
> Если другие транзакции держат часть нужных для эскалации ресурсов СУБД, то при попытке эскалации блокировок **СУБД MS SQL Server будет продолжать блокировать ресурсы "по одному"** и ждать, пока вся таблица не освободится.
> При попытке эскалации управляемых блокировок **"эскалирующая транзакция" попадёт в ожидание** от всех, кто ещё держит управляемые блокировки на этом ресурсе.

4. Возможна ли эскалация объектной блокировки при работе в разделенном сеансе?
> Ответ: Нет, эскалация объектной блокировки не возможная
> Объектная блокировка применяется всегда только к конкретному объекту. Понятие эскалации к ней, поэтому, неприменимо, **эскалаций объектных блокировок не бывает**.

5. Для регистра сведений, подчиненного регистратору, пространства блокировок "DIMS" и "RECORDER":
> DIMS — измерения RECORDER — регистратор
> Это разные пространства блокировок, они **не конфликтуют**

6. Возможно ли запретить эскалацию управляемых блокировок?
> Нет, нельзя
> Эскалация управляемых блокировок не отключается

7. Возникает ли эскалация управляемой блокировки по всему пространству блокировок какого-то ресурса включения в этот ресурс общих реквизитов при работе из разделенного сеанса?
> Ответ: Эскалация возникнет только в рамках области данных
> Если на иодно и то же пространство накладывается более 100'000 блокировок, то может произойти эскалация блокировки. При использовании независимых разделителей эскалация происходит для одного набора значений разделителей.
> - Блокируется всё пространство только в рамках значений разделителей
> - На сеансы с другими значениями разделителей влияния не оказывает

8. Выберите верное утверждение:
> - Чтение наборов записей регистров через объектную модель приводит к наложению управляемой блокировки
> - Получение прикладного объекта через ПолучитьОбъект() всегда происходит с использованием объектной блокировки
> Ответ: 2 и 4

9. Если метод Заблокировать() коллекции БлокировкаДанных выполняется **вне транзакции**:
> Блокировки установлены не будут

10. Как определить время, которое управляемая блокировка ожидала освобождения ресурса?
> По свойству события **TLOCK** в технологическом журнале

11. Для того, чтобы минимизировать влияние блокирующего чтения остатков на производительность системы, надо:
> выяснить, какие остатки нуждаются в блокирующем чтении, в начале транзакции в явном виде записать движения по всем регистрам, которые не требуют контроля остатков **(БлокироватьДляИзменения ставить ЛОЖЬ)**, выполнить все остальные действия, в самом конце транзакции в явном виде записать движения по тем регистрам, которые требуют контроля остатков (БлокироватьДляИзменения ставить ИСТИНА), для каждого регистра выполнить запрос контроля остатков (считывать только отрицательные остатки).

12. Есть непериодический независимый регистр сведений с тремя измерениями. Транзакция устанавливает **исключительную управляемую блокировку** сперва, в одной процедуре, только по первому измерению, затем, в другой процедуре, только по второму измерению. К чему это приведет?
> На этот регистр в других транзакциях нельзя будет поставить блокировки, которые будут принадлежать плоскости "первой" или "второй" блокировок, установленных в первой транзакции.

13. Как определить, какие именно управляемые блокировки были установлены?
> По технологическому журналу по событию **TLOCK**

14. Есть непериодический независимый регистр сведений с тремя измерениями. Транзакция устанавливает **разделяемую управляемую блокировку** сперва, в одной процедуре, только по первому измерению, затем, в другой процедуре, только по второму измерению. К чему это приведет?
> На этот регистр в других транзакциях нельзя будет поставить **исключительные** блокировки, которые будут принадлежать плоскости "первой" или "второй" блокировок одновременно.

15. Как режать проблему эскалации блокировок?
> Блокировать необходимые данные партиями, каждую — в отдельной транзакции, контроль успешности выполнения действий со всеми партиями делать внешними средствами.

16. Как узнать, что произошла эскалация блокировок в **MS SQL Server**?
> С помощью класса событий Locks:Lock:Escalation профайлера

17. Как узнать, что произошла эскалация **управляемых блокировок**?
> С помощью событий TLOCK в технологическом журнале

18. Какие бывают режимы управляемых блокировок 1С?
> Разделяемый и исключительный.

19. Какие виды объектных блокировок поддерживаются в системе 1С:Предприятие?
> Оптимистичный и пессимистичный

20. Какие есть поля пространства блокировок для следующих объектов: **Константа.<имя>**?
> Нет полей

21. Какие есть поля пространства блокировок для следующих объектов: **Перерасчет.<имя>**?
> ВидРасчета

22. Какие есть поля пространства блокировок для следующих объектов: **Перерасчет.<имя>.НаборЗаписей**?
> ОбъектПерерасчета

23. Какие есть поля пространства блокировок для следующих объектов: **Последовательность.<имя>**?
> <имя измерения>

24. Какие есть поля пространства блокировок для следующих объектов: **Последовательность.<имя>.НаборЗаписей**?
> Регистратор

25. Какие есть поля пространства блокировок для следующих объектов: **РегистрБухгалтерии.<имя>**?
> Период; <вид движения> - значение системного перечисления; ВидДвиженияБухгалтерии; Счет - обязательное поле; Субконто; <вид субконто>; <имя измерения>

26. Какие есть поля пространства блокировок для следующих объектов: **РегистрБухгалтерии.<имя>.НаборЗаписей**?
> Регистратор

27. Какие есть поля пространства блокировок для следующих объектов: **РегистрНакопления.<имя>**?
> Период; <имя измерения> 

28. Какие есть поля пространства блокировок для следующих объектов: **РегистрНакопления.<имя>.НаборЗаписей**?
> Регистратор

29. Что такое избыточная блокировка?
> Блокировка, не обсуловленная бизнес-логикой приложения

30. Какие есть поля пространства блокировок для следующих объектов: **РегистрРасчета.<имя>**?
> ПериодРегистрации;  ПериодДействия; <имя измерения>

31. Какие есть поля пространства блокировок для следующих объектов: **РегистрРасчета.<имя>.НаборЗаписей**?
> Регистратор

32. Какие есть поля пространства блокировок для следующих объектов: **РегистрСведений.<имя>**?
> Период - если есть; <имя измерения>

33. Какие есть поля пространства блокировок для следующих объектов: **РегистрСведений.<имя>.НаборЗаписей** (только для регистра сведений, подчиненного регистратору)?
> Регистратор

34. Какие проблемы были бы возможны, если бы не было пессимистических блокировок?
> Проблема потерянного обновления для объектов, редактируемых в форме
> Проблема неповторяющегося чтения для объектов, редактируемых в форме
> Ответ: 1 и 3

35. Какие по умолчанию есть поля пространства блокировок для следующих объектов:
**Справочник.<имя>		Документ.<имя>	ПланОбмена.<имя>		ПланСчетов.<имя>		БизнесПроцесс.<имя>		Задача.<имя> 		ПланВидовРасчета.<имя>		ПланВидовХарактеристик.<имя>**?
> Ссылка

36. Какие ресурсы блокируются при эскалации блокировок СУБД при работе с информационными системами на платформе 1С?
> Эскалация всегда происходит **до уровня таблицы**

37. Какие события в технологическом журнале будут указывать на то, что управляемую блокировку установить не удалось?
> TTIMEOUT & TDEADLOCK

38. Какие существуют способы задания условий на поля пространств блокировки?
> С помощью явного задания имени поля и его значения
> С помощью указания источника данных, содержащего необходимые значения
> Ответ: 1 и 2

39. Какие типы управляемых блокировок бывают?
> Разделяемые S и исключительные X

40. Когда оказывается заблокированной таблица целиком? Выберите наиболее полный правильный ответ.
> ~~Nested Loops~~
> В файловом, при эскалации, Clustered Index Scan, Index Scan, Пустой набор в пустую таблицу

41. Когда снимаются управляемые блокировки?
> При окончании транзакции

42. Когда технологической платформой устанавливаются неявные управляемые блокировки?
> При чтении наборов записей. При записи любых объектов.

43. Когда устанавливаются неявные управляемые разделяемые блокировки?
> При чтении набора записей.

44. Механизм объектных блокировок 1С:Предприятия позволяет:
> Оповестить пользователей о захвате объектных данных 1С:Предприятия (справочников, документов, планов счетов и т.д.)

45. Может ли информация, какую именно управляемую блокировку, несовместимую с блокировкой-жертвой, установило соединение, указанное в WaitConnections, находиться не втом же файле, где есть событие TDEADLOCK или TTIMEOUT?
> Да, она может быть в логах другого часа, другого рабочего процесса, и даже, если в кластере несколько серверов — в логах другого сервера.

46. Можно ли явно снять определенную транзакционнуюблокировку?
> Нет, встроенный язык не поддерживает такую возможность, т.к. это противоречит 2pl

47. Объектная оптимистичная блокировка предполагает, что:
> Во время обновления записи в базе мы единственные, кто меняет это запись

48. Объектная пессимистичная блокировка предполагает, что:
> Если что-то плохое может случиться, это обязательно случится — то есть если мы выполняем действие, конкуретное выполнение которого может привести к поломке данных, то парвильным будет исключить возможность конкурентного исполнения.

49. Почему поля пространства блокировок Регистратор и <имя измерения> не пересекаются?
> Регистратор отностится к Регистр(Сведений|Накопления|Бухгалтерии).<Имя>**.НаборЗаписей**

50. Пространства блокировок:
> Определены в платформе 8.1 и выше и соответсвуют структуре прикладных объектов конфигурации.

51. Пространство блокировок без суффикса НаборЗаписей:
> **Когда анализируются некторые данные этого объекта** (например остатки регистра), или **когда выполняются какие-либо операции, приводящие к изменению существующих данных объекта** (например восстановление границы последовательности)

52. Пространство блокировок с суффиксом НаборЗаписей:
> Когда необходимо заблокировать сами записи данного объекта (например при добавлении новых запсией)

53. Разделение итогов регистров накопления и бухгалтерии:
> Работает и в автоматическом и в управляемом режимах, но в автоматическом режиме свойство **БлокировтьДляИзменения** вызовет исключительную ситуацию

54. С какого числа записей в наборе начинается эскалация управляемых блокировок "1С:Предприятие 8.2"?
> с 20 000 записей в одной транзакции

55. С какого числа записей в наборе начинается эскалация управляемых блокировок "1С:Предприятие 8.3"?
> со 100 000 записей в одной транзакции ИБ

56. С помощью каких событий расследуется таймаут на управляемых блокировках?
> TLOCK & TIMEOUT

57. Свойство БлокироватьДляИзменения:
> в автоматическом режиме свойство БлокировтьДляИзменения **вызовет исключительную ситуацию**

58. Укажите правильный порядок событий в технологическом журнале при возникновении таймаута на управляемых блокировках:
> **TLOCK виновника** ...(возможно, другие TLOCK)... **TIMEOUT** ...(возможно, другие TLOCK)... **TLOCK жертвы**

59. Устанавливаются ли управляемые блокировкипри выполнении запроса?
> При выполнении запроса на языке запросов платформа самостоятельно **(неявно)** управляемые блокировки **не устанавливает**

60. Чем уровень (mode) блокировки отличается от уровня изоляции транзакции?
> Ответ: 1 и 2

61. Что произойдет, если **в момент эскалации упраляемой блокировки** по определенному пространству блокировок в этом пространстве **уже установлена какая-то несовместимая управляемая блокировка**?
> **Возникнет ожидание** при эскалации блокировки, пока несовместимая блокировка не будет снята либо не будет превышено время ожидания предоставления возможности установки блокировки.

62. Что такое блокировка?
> Это механизм, с помощью которого сервер (СУБД, а также 1С) синхронизирует одновременный доступ нескольких пользователей к одному фрагменту данных.




> Written with [StackEdit](https://stackedit.io/).
