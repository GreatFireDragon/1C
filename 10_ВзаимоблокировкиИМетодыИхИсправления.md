## 10. Взаимоблокировки и методы их исправления

1. Конфигурация в режиме совместимости с "**1С:Предприятие 8.2**". СУБД MS SQL Server. Для исправления взаимоблокировки вида **"захват ресурсов в разном порядке"**, когда она возникает **на исключительных блокировках СУБД**, необходимо:
> Найти второй ресурс и вторую транзакцию и изменить порядок захвата ресурсов

2. При борьбе с взаимоблокировками и необходимости перевода базы в управляемый режим управления блокировками правильная последовательность действий:
> Ответ: Сначала перевести базу в управляемый режим управления блокировками, только потом заниматься избалением от взаимоблокировок
> 
> Перевод в управляемый режим подразумевает:
> - Более мягкий уровень изоляции транзакций в СУБД
> - Установку управляемых блокировок
> В результате такого перехода многие взаимоблокировки могут исчесзнуть, т.к. перестанут использоваться механизмы, их вызывающие
> НО могут появитсья взаимоблокировки на управляемых блокировках. То есть, чтобы не делать бесполезную работу, нужно сначала перевести базу в управляемый режим, а только потом заниматься избавлением от взаимоблокировок.

3. Что такое взаимоблокировка?
> Ситуация, когда две или более **транзакции** джут друг друга из-за того, что каждая из сторон блокирует ресурс, необходимый другой стороне.

4. Какая схема представляет собой схему взаимоблокировки с повышением уровня блокировки ресурса (T1,T2 – транзакции, S/X –разделяемая/исключительная, Р1,Р2 – ресурсы)?
> S → X

5. Каковы наиболее типичные причины взаимоблокировок?
> - Захват ресурсов в разном порядке
> - Повышение изоляции транзакции
> - Неоптимальная работа запроса

6. Для чего на практике бывает нужно использовать свойство БлокироватьДляИзменения?
> Установка управляемой блокировки б**ез учета разделения итогов ухудшает параллельность записи, но защищает от взаимоблокировок**

7. Какая схема представляет собой схему взаимоблокировки с установкой блокировок в различном порядке (T1,T2 – транзакции, S/X – разделяемая/исключительная, Р1,Р2 – ресурсы)?
> - X → X
> - X → S

8. Если взаимоблокировка возникает по причине попыток эскалаций блокировок СУБД SQL Server в двух параллельных транзакциях (наборы не пересекаются), какая это будет взаимоблокировка?
> **В СУБД SQL Server эскалация блокировки** на таблицы, в которой "уже кто-то есть" — **не производится!**
> Ответ: Взаимоблокировки не произойдёт.

9. Если взаимоблокировка возникает по причине чтения остатков по регистру с включенным режимом разделения итогов после отмены проведения документов в двух параллельных транзакциях, какая это будет взаимоблокировка?
> Захват ресурсов в разном порядке

10. Есть регистр сведений с подчинением регистратору и периодичностью по позиции регистратора. Два сеанса пытаются записать одинаковые значения измерений. Т.к. регистр с подчинением регистратору и периодичностью по позиции регистратора, то запись проходит успешно. Далее в транзакции оба сеанса хотят получить срез последних по измерению. **Что произойдет?** Используется платформа "1С:Предприятие 8.2", управляемый режим управления блокировками, SQL Server.
> Ответ: **Взаимоблокировка СУБД** "захват ресурсов в разном порядке"

11. Есть регистр сведений с подчинением регистратору и периодичностью по позиции регистратора. Два сеанса пытаются записать одинаковые значения измерений. Т.к. регистр с подчинением регистратору и периодичностью по позиции регистратора, то запись проходит успешно. Далее в транзакции оба сеанса хотят получить срез последних по измерению. **Как предотвратить взаимоблокировку СУБД?** Используется платформа "1С:Предприятие 8.2", управляемый режим управления блокировками, SQL Server.
> Ответ: Ставить явную управляемую исключительную блокировку перед записью движений в базу. Это позволит организовать очередь.

12. Отличие взаимоблокировки от таймаута:
> При таймауте "жертва" получает сообщение об ошибке по умолчанию через 20 секунд,
> при взаимоблокировке — через [0,1-5]с, в некоторых случаях — немедленно

13. С помощью каких событий расследуется взаимоблокировка на управляемых блокировках?
> TLOCK & TDEADLOCK

14. Уменьшить вероятность возникновения взаимоблокировок могут следующие соглашения:
> ..., **блокировка в транзакции должна изначально осуществляться с максимально необходимым уровнем изоляции.** 

15. В информации о событии TDEADLOCK:
> В явном виде указано, кто кого ждёт (DeadlockConnectionIntersections='7 6)

16. Наличие буквы "I" в графе взаимоблокировки SQL Server (напр. IX):
> **Intent Блокировка с намерением** (IS, IX, SIX) — используется для создания иерархии блокировок.

17. Есть регистр сведений с подчинением регистратору и периодичностью по позиции регистратора. Два сеанса пытаются записать одинаковые значения измерений. Т.к. регистр с подчинением регистратору и периодичностью по позиции регистратора, то запись проходит успешно. Далее в транзакции оба сеанса хотят получить срез последних по измерению. **Как предотвратить управляемую взаимоблокировку?** Используется платформа "1С:Предприятие 8.2", управляемый режим управления блокировками, SQL Server.
> **Управляемой блокировик не будет**, но будет взаимоблокировка на уровне СУБД.

18. Какой инструмент позволяет проводить расследование взаимоблокировок СУБД MS SQL Server?
> ЦУП и Профайлер SQL Server
> Ответ: 3 и 4

19. Укажите правильный порядок событий в технологическом журнале **при возникновении взаимоблокировки на управляемых блокировках**:
> Ответ: **TLOCK-1 участника 1** ...(возможно другие)... **TLOCK-2 участника 2** ...(возможно другие)... **TDEADLOCK** ...(возможно другие)... **TLOCK-1 участника 1** ...(возможно другие)... **TLOCK-2 участника 2**
> 
> на практике наблюдается, что между любыми событиями схемы могут "влезть" чужие TLOCK

20. Есть регистр сведений с подчинением регистратору и периодичностью по позиции регистратора. Два сеанса пытаются записать одинаковые значения измерений. Т.к. регистр с подчинением регистратору и периодичностью по позиции регистратора, то запись проходит успешно. Далее в транзакции оба сеанса хотят получить срез последних по измерению. **Как предотвратить взаимоблокировку СУБД?** Используется платформа **"1С:Предприятие 8.3"**, управляемый режим управления блокировками, **PostgreSQL**.
> Ответ: Взаимоблокировки не будет
> ..., поэтому при чтении не будет попыток установить разделяемую блокировку СУБД на общую для транзакций область данных, а **будет прочитана согласованная версия данных**. 


